# 체크포인트 1: 기본 PTY 래퍼

## 개요
셸 프로세스를 생성하고 기본 입출력 작업을 처리할 수 있는 최소한의 의사 터미널(PTY) 래퍼를 구현합니다. 이는 모든 터미널 래핑 기능의 기반이 됩니다.

## 상태
- **우선순위**: 높음
- **상태**: 대기
- **예상 시간**: 4시간
- **의존성**: 체크포인트 0 (프로젝트 설정)

## 기술 요구사항

### 1. PTY 프로세스 생성
- **설명**: 의사 터미널에서 프로세스를 생성하는 클래스 생성
- **승인 기준**:
  - ptyprocess를 사용하여 셸 프로세스 생성 가능
  - 사용자 정의 셸 명령 지원 (bash, zsh, fish 등)
  - 프로세스 라이프사이클 처리 (시작, 중지, 정리)
  - 프로세스 상태 정보 제공
  - PTY 파일 디스크립터 적절한 관리

### 2. 기본 I/O 작업
- **설명**: PTY에 대한 기본 읽기/쓰기 작업 구현
- **승인 기준**:
  - PTY에 데이터 쓰기 가능 (사용자 입력 시뮬레이션)
  - PTY에서 데이터 읽기 가능 (프로세스 출력 캡처)
  - 블로킹 및 논블로킹 I/O 처리
  - UTF-8 텍스트 적절한 인코딩/디코딩
  - 버퍼 크기 적절한 관리

### 3. 프로세스 관리
- **설명**: 프로세스 상태 및 라이프사이클 관리 처리
- **승인 기준**:
  - 프로세스 PID 및 상태 추적
  - 프로세스 종료 우아하게 처리
  - 프로세스 종료 감지
  - 종료 시 리소스 정리
  - 프로세스 재시작 지원

### 4. 오류 처리
- **설명**: PTY 작업을 위한 견고한 오류 처리
- **승인 기준**:
  - PTY 생성 실패 처리
  - I/O 작업 오류 관리
  - 프로세스 생성 실패 우아하게 처리
  - 적절한 예외 타입 및 메시지
  - 디버깅을 위한 로깅

## 테스트 케이스

### 단위 테스트

#### test_pty_wrapper_creation
- **설명**: PTYWrapper가 인스턴스화될 수 있는지 테스트
- **테스트 타입**: 단위
- **예상 동작**: PTYWrapper가 기본 설정으로 성공적으로 생성됨

#### test_spawn_shell_process
- **설명**: 셸 프로세스 생성 테스트
- **테스트 타입**: 단위
- **예상 동작**: 셸 프로세스가 생성되고 올바르게 추적됨

#### test_write_to_pty
- **설명**: PTY에 데이터 쓰기 테스트
- **테스트 타입**: 단위
- **예상 동작**: PTY에 데이터가 오류 없이 쓰여짐

#### test_read_from_pty
- **설명**: PTY에서 데이터 읽기 테스트
- **테스트 타입**: 단위
- **예상 동작**: PTY 출력에서 데이터를 읽을 수 있음

#### test_process_termination
- **설명**: 프로세스 종료 처리 테스트
- **테스트 타입**: 단위
- **예상 동작**: 프로세스 종료가 감지되고 처리됨

### 통합 테스트

#### test_echo_command
- **설명**: 전체 echo 명령 실행 테스트
- **테스트 타입**: 통합
- **예상 동작**: echo 명령이 예상된 출력을 생성함

#### test_interactive_shell
- **설명**: 대화형 셸 명령 테스트
- **테스트 타입**: 통합
- **예상 동작**: 여러 명령이 순서대로 작동함

#### test_process_cleanup
- **설명**: 프로세스 종료 시 리소스 정리 테스트
- **테스트 타입**: 통합
- **예상 동작**: 모든 리소스가 적절히 정리됨

### 엔드투엔드 테스트

#### test_basic_terminal_session
- **설명**: 완전한 터미널 세션 테스트
- **테스트 타입**: E2E
- **예상 동작**: 전체 터미널 세션이 예상대로 작동함

## 결과물

### 1. PTYWrapper 클래스
- **위치**: src/term2ai/core/pty_wrapper.py
- **설명**: 핵심 PTY 래퍼 구현
- **인터페이스**:
  ```python
  class PTYWrapper:
      def __init__(self, shell: str = "/bin/bash")
      def spawn(self) -> None
      def write(self, data: str) -> int
      def read(self, size: int = 1024) -> str
      def is_alive(self) -> bool
      def terminate(self) -> None
      def get_exit_code(self) -> Optional[int]
  ```

### 2. 프로세스 관리 유틸리티
- **위치**: src/term2ai/utils/process.py
- **설명**: 프로세스 관리를 위한 유틸리티 함수
- **함수**:
  - `find_shell()`: 사용 가능한 셸 자동 감지
  - `validate_shell()`: 셸 실행 파일 검증
  - `get_shell_info()`: 셸 버전 및 정보 획득

### 3. 테스트 스위트
- **위치**: tests/test_checkpoint_01_basic_pty/
- **설명**: PTY 래퍼를 위한 포괄적인 테스트
- **파일**:
  - `test_pty_wrapper.py`: PTYWrapper 단위 테스트
  - `test_process_management.py`: 프로세스 라이프사이클 테스트
  - `test_integration.py`: 통합 테스트
  - `conftest.py`: 테스트 픽스처 및 구성

### 4. 타입 정의
- **위치**: src/term2ai/models/pty.py
- **설명**: PTY 작업을 위한 Pydantic 모델
- **모델**:
  - `PTYConfig`: PTY 래퍼 구성
  - `ProcessState`: 프로세스 상태 추적
  - `IOOperation`: 입출력 작업 레코드

## 구현 참고사항

### 핵심 의존성
- **ptyprocess**: 주요 PTY 처리 라이브러리
- **pexpect**: 고급 PTY 작업을 위한 대체
- **typing**: 더 나은 코드 품질을 위한 타입 힌트

### 주요 설계 결정
1. **블로킹 vs 논블로킹 I/O**: 두 모드 모두 지원
2. **버퍼 관리**: 구성 가능한 버퍼 크기
3. **오류 복구**: 오류 시 우아한 성능 저하
4. **리소스 정리**: 컨텍스트 종료 시 자동 정리

### 테스트 전략
- 단위 테스트를 위한 PTY 작업 모킹
- 통합 테스트를 위한 실제 PTY 사용
- 다양한 셸에 대한 매개변수화된 테스트
- I/O 작업에 대한 성능 테스트

## 승인 기준
- [ ] 모든 단위 테스트 통과 (100% 성공률)
- [ ] 실제 PTY로 통합 테스트 통과
- [ ] 핵심 기능에 대해 ≥90% 코드 커버리지
- [ ] mypy로 타입 검사 통과
- [ ] ruff로 린팅 통과
- [ ] 문서 완성 및 정확성

## 다음 체크포인트
기본 PTY 래퍼가 구현되고 테스트되면 [체크포인트 2: I/O 처리](02_io_handling.md)로 진행합니다.