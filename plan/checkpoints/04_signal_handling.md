# 체크포인트 4: 시그널 처리

## 개요
프로세스 제어 시그널, 창 크기 변경 시그널, 자식 프로세스로의 적절한 시그널 전파를 포함한 터미널 래퍼의 포괄적인 시그널 처리를 구현합니다. 이는 터미널 래퍼가 모든 시그널 시나리오에서 올바르게 작동하도록 보장합니다.

## 상태
- **우선순위**: 높음
- **상태**: 대기
- **예상 시간**: 4시간
- **의존성**: 체크포인트 3 (터미널 상태 관리)

## 기술 요구사항

### 1. 프로세스 제어 시그널
- **설명**: 프로세스 제어 시그널 처리 (SIGINT, SIGTERM, SIGQUIT 등)
- **승인 기준**:
  - SIGINT (Ctrl+C) 가로채기 및 적절한 처리
  - 우아한 종료를 위한 SIGTERM 처리
  - SIGQUIT 및 기타 제어 시그널 지원
  - 자식 프로세스로의 적절한 시그널 전파
  - 시그널 마스킹 및 복원

### 2. 창 크기 변경 시그널 처리
- **설명**: 터미널 창 크기 변경을 위한 SIGWINCH 처리
- **승인 기준**:
  - SIGWINCH를 통한 창 크기 변경 감지
  - 크기 변경 시 터미널 상태 업데이트
  - 자식 프로세스로 크기 변경 이벤트 전파
  - 빠른 크기 변경 이벤트 효율적 처리
  - 터미널 상태 관리자와 조정

### 3. 작업 제어 시그널
- **설명**: 작업 제어 시그널 지원 (SIGTSTP, SIGCONT)
- **승인 기준**:
  - 프로세스 일시정지를 위한 SIGTSTP (Ctrl+Z) 처리
  - 프로세스 계속을 위한 SIGCONT 처리
  - 적절한 포그라운드/백그라운드 프로세스 그룹 유지
  - 자식 프로세스에서 작업 제어 지원
  - 일시정지/재개 간 터미널 상태 보존

### 4. 시그널 안전성 및 조정
- **설명**: 시그널 핸들러가 안전하고 적절히 조정되도록 보장
- **승인 기준**:
  - 핸들러에서 비동기 시그널 안전 함수만 사용
  - 적절한 시그널 동기화 구현
  - 시그널 전달 경쟁 상태 처리
  - 시그널 핸들러 체이닝 지원
  - 시그널 오류 시 우아한 성능 저하

## 테스트 케이스

### 단위 테스트

#### test_sigint_handling
- **설명**: SIGINT 시그널 처리 테스트
- **테스트 타입**: 단위
- **예상 동작**: SIGINT가 적절히 가로채지고 처리됨

#### test_sigterm_handling
- **설명**: SIGTERM 시그널 처리 테스트
- **테스트 타입**: 단위
- **예상 동작**: SIGTERM이 우아한 종료를 트리거함

#### test_sigwinch_handling
- **설명**: SIGWINCH 시그널 처리 테스트
- **테스트 타입**: 단위
- **예상 동작**: 창 크기 변경 시그널이 올바르게 처리됨

#### test_sigtstp_handling
- **설명**: SIGTSTP 시그널 처리 테스트
- **테스트 타입**: 단위
- **예상 동작**: 프로세스 일시정지가 올바르게 작동함

#### test_signal_propagation
- **설명**: 자식 프로세스로의 시그널 전파 테스트
- **테스트 타입**: 단위
- **예상 동작**: 시그널이 자식 프로세스로 전달됨

#### test_signal_masking
- **설명**: 시그널 마스킹 작업 테스트
- **테스트 타입**: 단위
- **예상 동작**: 시그널 마스크가 올바르게 적용되고 복원됨

### 통합 테스트

#### test_interactive_interrupt
- **설명**: 대화형 시그널 처리 테스트 (Ctrl+C)
- **테스트 타입**: 통합
- **예상 동작**: 대화형 인터럽트가 예상대로 작동함

#### test_window_resize_coordination
- **설명**: 크기 변경과 터미널 상태 간 조정 테스트
- **테스트 타입**: 통합
- **예상 동작**: 크기 변경 이벤트가 터미널 상태를 적절히 업데이트함

#### test_job_control_flow
- **설명**: 완전한 작업 제어 흐름 테스트
- **테스트 타입**: 통합
- **예상 동작**: 전체 작업 제어 시퀀스가 올바르게 작동함

### 엔드투엔드 테스트

#### test_signal_compatibility
- **설명**: 셸 동작과의 시그널 호환성 테스트
- **테스트 타입**: E2E
- **예상 동작**: 시그널이 표준 터미널처럼 동작함

#### test_nested_process_signals
- **설명**: 중첩 프로세스와의 시그널 테스트
- **테스트 타입**: E2E
- **예상 동작**: 시그널이 프로세스 계층 구조와 올바르게 작동함

## 결과물

### 1. 시그널 관리자
- **위치**: src/term2ai/core/signal_manager.py
- **설명**: 중앙 시그널 처리 관리
- **인터페이스**:
  ```python
  class SignalManager:
      def __init__(self, pty_wrapper: PTYWrapper)
      def setup_signal_handlers(self) -> None
      def cleanup_signal_handlers(self) -> None
      def handle_signal(self, signum: int, frame) -> None
      def propagate_signal(self, signum: int) -> None
      def mask_signals(self, signals: List[int]) -> None
  ```

### 2. 시그널 핸들러
- **위치**: src/term2ai/core/signal_handlers.py
- **설명**: 개별 시그널 핸들러 구현
- **클래스**:
  - `SigintHandler`: SIGINT 시그널 처리
  - `SigwinchHandler`: 창 크기 변경 시그널 처리
  - `SigtstpHandler`: 일시정지 시그널 처리
  - `SigtermHandler`: 종료 시그널 처리

### 3. 프로세스 그룹 관리자
- **위치**: src/term2ai/core/process_groups.py
- **설명**: 작업 제어를 위한 프로세스 그룹 관리
- **클래스**:
  - `ProcessGroupManager`: 프로세스 그룹 작업 관리
  - `JobControlManager`: 작업 제어 시그널 처리
  - `ForegroundManager`: 포그라운드 프로세스 그룹 관리

### 4. 시그널 유틸리티
- **위치**: src/term2ai/utils/signals.py
- **설명**: 시그널 관련 유틸리티 함수
- **함수**:
  - `signal_name()`: 번호에서 시그널 이름 획득
  - `is_signal_safe()`: 함수가 시그널 안전한지 확인
  - `setup_signal_fd()`: 시그널 처리를 위한 self-pipe 설정
  - `restore_default_handlers()`: 기본 시그널 핸들러 복원

### 5. 시그널 모델
- **위치**: src/term2ai/models/signals.py
- **설명**: 시그널 처리를 위한 Pydantic 모델
- **모델**:
  - `SignalConfig`: 시그널 처리 구성
  - `SignalEvent`: 시그널 이벤트 정보
  - `ProcessGroup`: 프로세스 그룹 정보
  - `JobControlState`: 작업 제어 상태

### 6. 테스트 스위트
- **위치**: tests/test_checkpoint_04_signal_handling/
- **설명**: 포괄적인 시그널 처리 테스트
- **파일**:
  - `test_signal_manager.py`: 시그널 관리자 테스트
  - `test_signal_handlers.py`: 개별 핸들러 테스트
  - `test_process_groups.py`: 프로세스 그룹 테스트
  - `test_job_control.py`: 작업 제어 테스트
  - `test_signal_integration.py`: 통합 테스트

## 구현 참고사항

### 시그널 핸들러 안전성 (Unix 최적화)
- Unix 전용 비동기 시그널 안전 함수 최적화 활용
- Unix 전용 self-pipe 기법과 epoll/kqueue 통합 구현
- Unix 네이티브 시그널 핸들러 최적화로 작업 최소화
- Linux signalfd와 macOS kqueue 최적 시그널 처리

### 프로세스 그룹 관리
- 자식 프로세스를 위한 새 프로세스 그룹 생성
- 포그라운드/백그라운드 프로세스 그룹 전환 처리
- 적절한 터미널 소유권 관리 구현
- 프로세스 그룹 계층 구조 지원

### 시그널 조정
- 시그널 전달 제어를 위한 시그널 마스크 사용
- 적절한 시그널 동기화 프리미티브 구현
- 시그널 전달 경쟁 상태 주의 깊게 처리
- 호환성을 위한 시그널 핸들러 체이닝 지원

### 플랫폼 고려사항
- 시그널 동작의 플랫폼 차이 처리
- 가능한 경우 POSIX 시그널 인터페이스 사용
- 제한된 플랫폼을 위한 대체 구현
- 다양한 운영 체제에서 테스트

## 테스트 전략

### 단위 테스트
- 단위 테스트를 위한 시그널 전달 모킹
- 시그널 핸들러 함수를 격리하여 테스트
- 시그널 전파 테스트를 위한 프로세스 그룹 사용
- 시그널 마스킹 및 복원 테스트

### 통합 테스트
- 제어된 환경에서 실제 시그널 사용
- 시그널 타이밍 및 조정 테스트
- 자식 프로세스로의 시그널 전파 확인
- 터미널 상태와의 상호작용 테스트

### 스트레스 테스트
- 빠른 시그널 전달 테스트
- 부하 하에서 시그널 처리 테스트
- 시그널 핸들러 성능 확인
- 시그널 큐 오버플로 시나리오 테스트

## 성능 고려사항
- 시그널 핸들러 실행 시간 최소화
- 효율적인 시그널 전달 메커니즘 사용
- 가능한 경우 시그널 처리 일괄화
- 시그널 마스크 작업 최적화

## 보안 고려사항
- 가능한 경우 시그널 소스 검증
- 시그널 인젝션 공격 방지
- 신뢰할 수 없는 자식 프로세스 안전하게 처리
- 적절한 권한 분리 구현

## 승인 기준
- [ ] 모든 프로세스 제어 시그널이 올바르게 처리됨
- [ ] 창 크기 변경 시그널이 터미널 상태를 업데이트함
- [ ] 작업 제어 시그널이 예상대로 작동함
- [ ] 자식 프로세스로의 시그널 전파가 작동함
- [ ] 시그널 핸들러가 비동기 시그널 안전함
- [ ] 프로세스 그룹이 올바르게 관리됨
- [ ] 표준 셸 동작과 호환됨
- [ ] 모든 테스트가 ≥95% 커버리지로 통과함
- [ ] 시그널 관련 경쟁 상태가 없음
- [ ] 코드가 타입 검사 및 린팅 통과함

## 다음 체크포인트
시그널 처리가 견고하고 완전하면 [체크포인트 5: ANSI 파싱](05_ansi_parsing.md)로 진행합니다.